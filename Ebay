import os
import sys
import ebaysdk
import time
from ebaysdk.finding import Connection as Finding
from ebaysdk.shopping import Connection as Shopping
from ebaysdk.soa.finditem import Connection as FindItem
from ebaysdk.exception import ConnectionError
import time
from socket import socket

# variable
waitDuration = 60
SearchKeywords = ['kodi', 'iptv','set top box', 'kodi tv box', 'kodi box', 'loaded television', 'pre-modded', 'hacked modems', 'descrambler' ]

# Local Carbon/Graphite Server Settings for Grafana
CARBON_SERVER = '18.207.154.217'  # Grafana on AWS
CARBON_PORT = 2003


# Open Graphite/Carbon connection for Grafana
def getDataByKeyword(api, keyword):
    sock = socket()
    try:
        sock.connect((CARBON_SERVER, CARBON_PORT))
    except:
        print("Couldn't connect to %(server)s on port %(port)d, is carbon-agent.py running?" % {'server': CARBON_SERVER,
                                                                                                'port': CARBON_PORT})
        sys.exit(1)

    try:
        api_request = {
            'keywords': keyword,
            'itemFilter': [
                {'name': 'Condition', 'value': 'New'},
                {'name': 'LocatedIn', 'value': 'US'}
            ]
        }
        response = api.execute('findItemsAdvanced', api_request)
        print(api_request['keywords'])
        print("Found %s items:" % response.reply.paginationOutput.totalEntries)
        # Database record format = <metric name in dot format e.g. name.subname.subsubname> <timestamp> with a newline (e.g. \n)  at the end
        kw = keyword.replace(" ", "")
        message = "ebay." + kw + ' ' + str(response.reply.paginationOutput.totalEntries) + " " + str(time.time()) + "\n"
        #message = 'ebay.kodi 3 1530123037' + '\n'
        # Store the record in the time series database by sending it via socket call
        print(message)
        try:
            sock.sendall(message.encode())  # send the result to Carbon/Graphite
        except:
            print('failed to send')
            e = sys.exe.info()[0]
            print(e)
    except ConnectionError as e:
        print(e)
        print(e.response.dict())


while True:
    api = Finding(appid='BetelAsf-settopbo-PRD-4668815a4-61c6d13d', config_file=None)
    for keyword in SearchKeywords:
        getDataByKeyword(api, keyword)

    time.sleep(waitDuration)  # pause for 60 seconds
